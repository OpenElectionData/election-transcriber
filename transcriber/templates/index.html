{% extends 'base.html' %}
{% block title %}Home{% endblock %}
{% block content %}
<div class="row">
    <div class="col-sm-12">
        <h1>Election Results Transcriber</h1>

        {% if tasks %}

            <p>
                <a href="{{ url_for('views.upload') }}" class="btn btn-success">New transcription task &raquo; </a>
            </p>

            <table class='table' id='transcription_tasks'>
                <thead>
                    <tr>
                        <th>Transcription task</th>
                        <th>Created</th>
                        <th></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in tasks %}
                        <tr>
                            <td>Edit <a href='/form-creator/?form_id={{t.id}}'>{{t.name}}</a></td>
                            <td>
                                <span class='date-created' datetime='{{t.date_added | format_date_sort}}'>
                                    {{t.date_added | format_date }}
                                </span>
                            </td>
                            <td><a href='/transcribe/?task_id={{t.id}}'>Start transcribing &raquo;</a></td>
                            <td><a class="delete-task" href="javascript://" data-task_id="{{t.id}}">Delete</a></td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

        {% else %}
            <p>
                <a href="{{ url_for('views.upload') }}" class="btn btn-primary">Create your first transcription task > </a>
            </p>
        {% endif %}
    </div>
</div>


{% endblock %}

{% block extra_javascript %}
    <script src="{{ url_for('static', filename='js/jquery.dataTables.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery.dataTables.sorting.js') }}"></script>
    <script type='text/javascript'>
        $(document).ready(function(){

            // $.each($('.date-created'), function(i, el) {
            //     var date = $(this)
            //     console.log(moment(date.html(), "YYYY-MM-DD HH:mm:ss.S Z"))
            //     console.log(moment.utc().utcOffset('-06:00'))
            //     date.html(moment(date.html(),"YYYY-MM-DD HH:mm:ss.S Z").from(moment().utcOffset('-06:00')))
            // })
            $('.delete-task').on('click', function(e){
                var task_id = $(this).data('task_id');
                var self = $(this)
                $.when(deleteTask(task_id)).then(function(resp){
                    console.log(resp);
                    self.parent().parent().remove()
                })
            })
            $('#transcription_tasks').DataTable( {
                "aaSorting": [ [1,'desc'] ],
                "aoColumns": [
                    null,
                    { "sType": "datetime" },
                    null
                ],
                "paging": false,
                "searching": false,
                "info": false
            } );
        });
        function deleteTask(task_id){
            return $.ajax({
                url: '/delete-part/',
                data: {'part_id': task_id, 'part_type': 'form'},
                dataType: 'json',
                type: 'DELETE'
            })
        }
    </script>
{% endblock %}
