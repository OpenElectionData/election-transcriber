{% extends 'base.html' %}
{% from 'macros.html' import render_image %}
{% block title %}{{task.name}}{% endblock %}
{% block content %}

<div>
    <strong>{{task.name}}</strong>
    <button type="button" data-toggle="modal" data-target="#help-modal" class="btn btn-link"><i class='fa fa-info-circle fa-lg'></i></button>
</div>

<div class="row">
    <div class='col-md-6'>
        {{ render_image() }}
    </div>
    <div class="col-sm-6">
        <form id="transcriber" role="form" class="form-horizontal" method="POST" action="">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            {% for section in task.sections %}
                <div class="well">
                    <h3>{{ section.name }}</h3>
                    {% for field in section.fields %}
                        {% set form_field = form|attr(field.slug) %}
                        {% set form_blank = form|attr(field.slug + '_blank') %}
                        {% set form_not_legible = form|attr(field.slug + '_not_legible') %}
                        {% if form_field.errors %}
                        <div class="form-group has-error">
                        {% else %}
                        <div class="form-group">
                        {% endif %}
                            <div class="row">
                                <div class="col-sm-12">
                                    {% if form_field.type == 'StringField' %}
                                        <label for="id_{{ field.slug }}" class="col-sm-3 control-label">{{ field.name }}</label>
                                        <div class='col-sm-6'>
                                            {{ form_field(class_='form-control') }}
                                        </div>

                                    {% elif form_field.type == 'TranscriberIntegerField' %}
                                        <label for="id_{{ field.slug }}" class="col-sm-3 control-label">{{ field.name }}</label>
                                        <div class='col-sm-6'>
                                            {{ form_field(class_='form-control') }}
                                        </div>

                                    {% elif form_field.type == 'BooleanField' %}
                                        <div class="checkbox col-sm-offset-3">
                                            <label>
                                                {{ form_field }} {{ field.name }}
                                            </label>
                                        </div>

                                    {% elif form_field.type == 'TranscriberDateField' %}
                                        <label for="id_{{ field.slug }}" class="col-sm-3 control-label">{{ field.name }}</label>
                                        <div class='col-sm-6'>
                                            {{ form_field(class_='form-control') }}
                                        </div>

                                    {% elif form_field.type == 'TranscriberDateTimeField' %}
                                        <label for="id_{{ field.slug }}" class="col-sm-3 control-label">{{ field.name }}</label>
                                            <div class='col-sm-6 input-group date datetimepicker'>
                                            {{ form_field(class_='form-control') }}
                                            <span class="input-group-addon"><span class="fa fa-calendar"></span></span>
                                            </div>

                                    {% endif %}
                                    <div class="col-sm-offset-6">
                                        <div class="checkbox field-checks">
                                            <label>
                                                {{ form_blank }} <small>Blank?</small>
                                            </label>
                                            <label>
                                                {{ form_not_legible }} <small>Not legible?</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-12">
                                    {% if form_field.errors %}
                                        {% for error in form_field.errors %}
                                        <span class="help-block"><i class="fa fa-remove"> </i> {{error}}</span>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
            <div class="form-group">
                <div class="col-sm-12">
                    <button class="btn btn-success" id="save-form">
                        <i class='fa fa-check'></i>
                        Submit
                    </button>
                    {% if task.images_left %}
                        <div class='pull-right'>
                        <i class="fa fa-file-text-o fa-fw"></i> <strong>{{task.images_left}}</strong> documents remaining
                        </div>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>
</div>

<div id="help-modal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <p class="modal-title"><strong>{{task.name}} - Info</strong></p>
            </div>
            <div class="modal-body">
                {% if task.description %}
                    <p>{{task.description}}</p><br>
                {% endif %}
                <p>
                {% if task.reviewer_count %}
                    <i class="fa fa-user fa-fw"></i> <strong>{{task.reviewer_count}}</strong> reviewers per document<br>
                {% endif %}
                {% if task.deadline %}
                    <i class="fa fa-calendar fa-fw"></i> due {{task.deadline | format_date}}<br>
                {% endif %}
                </p>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


{% endblock %}
{% block extra_javascript %}
    <script src="{{ url_for('static', filename='js/jquery.panzoom.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bootstrap-datetimepicker.min.js') }}"></script>
    <script type="text/javascript">
        $(document).ready(function(){
            $('.datetimepicker').datetimepicker();

            $('.panzoom').panzoom({
                $zoomRange: $('input[type="range"]')
            });
        })

        //dynamically set the size of the image iframe
        $(window).resize(function () {
          var h = $(window).height(),
            offsetTop = 95; // Calculate the top offset

          $('#result-image').css('height', (h - offsetTop));
        }).resize();
    </script>
{% endblock %}
